<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/8/16
 * Time: 20:12
 */

namespace app\wap\controller;


class Teachercollect extends MobileMember
{
    public function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
    }

    //课件收藏列表列表
    public function lists(){
        $member_id = intval(input('post.member_id'));
        if(empty($member_id)){
            output_error('member_id参数有误');
        }
        $collect = model('Membercollect');
        $condition=array();
        $condition['member_id'] = $member_id;
        $condition['isdel'] = 1;
        $condition['type_id'] = 1;
        $last_id = input('post.page');
        if($last_id){
            $last_info = db('membercollect')->where("time <".$last_id." and member_id=".$member_id." and isdel=1")->order('time desc')->find();
            $strtime = strtotime(date("Y-m-d",$last_info['time'])." 00:00:00");
            $endtime = $strtime+24*3600;
            $result = $collect->getCollect("member_id=".$member_id." and isdel=1 and type_id=1 and time<".$endtime." and time>=".$strtime);
        }else{
            $result=$collect->getMembercollectList($condition,'',1,'time desc',10);
            if(count($result)==10){
                foreach($result as $kk=>$vv){
                    $time = $vv['time'];
                }
                $strtime = strtotime(date("Y-m-d",$time)." 00:00:00");
                $endtime = $strtime+24*3600;
                $day = db('membercollect')->where("member_id=".$member_id." and isdel=1 and type_id=1 and time<".$endtime." and time>=".$strtime)->order('time desc')->select();
                $result=array_merge($result,$day);
                $result=array_unique($result, SORT_REGULAR);
            }
        }
        foreach($result as $k=>$v){
            $result[$k]['date'] = date("Y-m-d",$v['time']);
            if(date("Y-m-d",time()) == date("Y-m-d",$v['time'])){
                $result[$k]['date'] = "今天";
            }
            $videoinfo = db('teachchild')->where(array('t_id'=>$v['collect_id']))->find();
            $result[$k]['title'] = $videoinfo['t_title'];
            $result[$k]['profile'] = $videoinfo['t_profile'];
            $result[$k]['price'] = $videoinfo['t_price'];
            $result[$k]['videoimg'] = $videoinfo['t_videoimg'];
            $result[$k]['videourl'] = $videoinfo['t_url'];
            $result[$k]['author'] = $videoinfo['t_author'];
            if($videoinfo['t_price']==0){
                $result[$k]['is_click'] = $videoinfo['t_del']==2 ? 0 : 1;
            }else{
                $orderinfo = db('packagesorderteach')->where(array('buyer_id'=>$member_id,'order_tid'=>$videoinfo['t_id'],'order_state'=>20))->order('order_id desc')->limit(1)->find();
                if(!empty($orderinfo)){
                    if($orderinfo['order_dieline']>time()){
                        $result[$k]['is_click'] = 1;
                    }else{
                        $result[$k]['is_click'] = $videoinfo['t_del']==2 ? 0 : 1;
                    }
                }else{
                    $result[$k]['is_click'] = $videoinfo['t_del']==2 ? 0 : 1;
                }
            }
        }
        foreach($result as $key=>$item){
            $data[$item['date']][] = $item;
            $last_id = $item['time'];
        }
        $datas = !empty($data) ? [$data] : $data;
        if(!empty($datas[0])){
            $datas[1]['id'] = !empty($last_id)?$last_id:"";
        }
        output_data($datas);
    }

    //收藏课件
    public function collect(){
        $tid = intval(input('post.tid'));
        $member_id = intval(input('post.member_id'));
        if(empty($tid) || empty($member_id)){
            output_error('参数有误');
        }
        $condition = array();
        $condition['member_id'] = $member_id;
        $condition['collect_id'] = $tid;
        $condition['type_id'] = 1;
        $collect = model('Membercollect');
        $res = $collect->getMembercollectInfo($condition);
        $condition['time'] = time();
        if($res){
            $condition['isdel'] = $res['isdel']==1? 2 : 1;
            $result = $collect->editMembercollect(array('id'=>$res['id']),$condition);
            if($condition['isdel']==1){
                output_data([array('data'=>"收藏成功")]);
            }else{
                output_data([array('data'=>"取消收藏成功")]);
            }
        }else {
            $result = $collect->addMembercollect($condition);
            if ($result) {
                output_data([array('data'=>"收藏成功")]);
            } else {
                output_error('收藏失败');
            }
        }
    }

    //取消收藏
    public function delcollect(){
        $all = intval(input('post.all'));//全部取消
        $ids = input('post.ids');//多个取消  逗号分隔
        $userid = intval(input('post.member_id'));
        if(empty($ids) || empty($userid)){
            output_error('参数有误');
        }
        if($all==1){
            $where = "member_id={$userid} and isdel=1 and type_id=1";
        }else{
            $where = "member_id={$userid} and type_id=1 and id in ({$ids})";
        }
        $collect = model('Membercollect');
        $result = $collect->editMembercollect($where,array('isdel'=>2));
        if ($result) {
            output_data([array('data'=>"取消成功")]);
        } else {
            output_error('取消失败');
        }
    }

}