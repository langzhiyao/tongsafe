<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/8/16
 * Time: 20:12
 */

namespace app\wap\controller;


class Robotroster extends MobileMall
{
    public function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
    }

    //机器人认证
    public function auth(){
        $input = input();
        //db('testt')->insertGetId(['content'=>json_encode(['input'=>$input,'InputTime'=>date('Y-m-d H:i:s'),'method'=>'Robotroster_auth'])]);
        $SNNumber = $input['SNNumber'];
        if(empty($SNNumber)){
            $ret = array("data"=>'','msg'=>"fail",'ret'=>"00001");
            return json_encode($ret);
        }
        $model_robot = Model("Robot");
        $data = $model_robot->getOne(array('r.SNNumber'=>$SNNumber,'r.isdel'=>1));
        $datas = array();
        $datas['schoolId'] = !empty($data['schoolid'])?$data['schoolid']:"";
        $datas['schoolName'] = !empty($data['name'])?$data['name']:"";
        $ret = array("data"=>!empty($datas)?$datas:"",'msg'=>"success",'ret'=>"00000");
        return json_encode($ret);
    }

    //获取花名册
    public function roster(){
        $school_id = input('post.schoolId');
        if(empty($school_id)){
            $ret = array('ret'=>"00001","data"=>[],'msg'=>"fail");
            return json_encode($ret);
        }
        $model_student = Model("Student");
        $data = $model_student->getAllStudent(array('s_schoolid'=>$school_id));
        $insert = [
            'school_id' => $school_id,
            'SNNumber' => input('post.SNNumber')?input('post.SNNumber'):"",
            'create_time' => time()
        ];
        $model_roster = Model("Robotroster");
        $model_roster->rosterAdd($insert);
        $datas = array();
        foreach($data as $k=>$v){
            $datas[$k]['uid'] = $v['s_id'];
            $datas[$k]['userCode'] = $v['s_card'];
            $datas[$k]['userName'] = $v['s_name'];
            $datas[$k]['sex'] = $v['s_sex']==2?0:1; //0女 1男
            $datas[$k]['clazzName'] = $v['classname'];
            $datas[$k]['clazzId'] = $v['s_classid'];
            $datas[$k]['status'] = $v['s_del']==2?0:1;
        }
        $ret = array("data"=>!empty($datas)?$datas:[],'msg'=>"success",'ret'=>"00000");
        return json_encode($ret);
    }

}